<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Jogo de Tabuada Avan√ßado</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1>üß† Desafio Matem√°tico</h1>
    </header>

    <main>
        <div class="game-container"> 
            <p id="welcome-message" style="color: var(--accent-color); font-weight: 600;">Carregando...</p>
            
            <div id="config">
                <h2>Configura√ß√µes do Desafio</h2>
                
                <div class="config-section">
                    <label for="nivelSelecionado">N√≠vel:</label>
                    <select id="nivelSelecionado">
                        <option value="facil" selected>F√°cil (Tabuada Aleat√≥ria)</option>
                        <option value="medio">M√©dio (Tabuada Espec√≠fica)</option>
                        <option value="dificil">Dif√≠cil (Express√µes Mistas)</option>
                    </select>
                </div>

                <div class="config-section" id="tabuadaEspec">
                    <label for="fatorSelecionado">Tabuada de:</label>
                    <select id="fatorSelecionado">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                    </select>
                </div>

                <div class="config-section" id="operacaoSel">
                    <label for="operacaoSelecionada">Opera√ß√£o Principal:</label>
                    <select id="operacaoSelecionada">
                        <option value="*">Multiplica√ß√£o (√ó)</option>
                        <option value="/">Divis√£o (√∑)</option>
                        <option value="+">Adi√ß√£o (+)</option>
                        <option value="-">Subtra√ß√£o (-)</option>
                    </select>
                </div>

                <div class="config-section">
                    <label for="tempoSelecionado">Tempo Total:</label>
                    <select id="tempoSelecionado">
                        <option value="30">30 segundos</option>
                        <option value="60" selected>60 segundos</option>
                        <option value="120">120 segundos</option>
                    </select>
                </div>
                
                <button onclick="iniciarJogo()" style="margin-top: 20px;">Iniciar Desafio</button>
            </div>

            <div id="jogo" style="display:none;">
                <p id="timer">‚è≥ Tempo: 60s</p>
                <p id="pergunta">Carregando pergunta...</p>
                <input type="number" id="resposta" placeholder="Sua resposta" onkeyup="if(event.key === 'Enter') verificar()">
                <br>
                <button onclick="verificar()" id="btnResponder">Responder</button>
                <p id="mensagem"></p>
                <p style="font-size: 18px;">Pontua√ß√£o: <span id="pontos">0</span></p>
                <p style="font-size: 14px;">Acertos para o b√¥nus: <span id="bonusCounter">10</span></p>

                <div id="graficoFinal">
                    <h2>üìä Resultado Final</h2>
                    <canvas id="meuGrafico"></canvas>
                    <button onclick="reiniciarPontos()" style="margin-top: 15px;">Novo Jogo (Mesma Config)</button>
                    <button onclick="window.location.reload()" style="background: var(--secondary-color);">Mudar Configura√ß√µes</button>
                </div>
            </div>
            
            <div id="historicoSection" style="display:none; text-align: left;">
                <h2>üìú Hist√≥rico de Partidas</h2>
                <ul id="historicoList"></ul>
                <button onclick="hideHistorico()" style="background: var(--secondary-color);">Voltar</button>
            </div>

            <div class="bottom-buttons">
                <button onclick="showHistorico()" style="background-color: #00bcd4;">Ver Hist√≥rico</button>
                <button onclick="handleLogout()" class="btn-logout">Sair da Conta</button>
            </div>
        </div>
    </main>

    <footer>
        <p>Desenvolvido por Voc√™ ¬© 2025</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let pontos = 0, erros = 0, tempo, intervalo, meuGrafico;
        let nivel, operacao, fator, acertosParaBonus = 10, pontosNaPartida = 0;
        let perguntaAtual, respostaCorretaAtual;

        // --- Fun√ß√µes de Utilit√°rio e Hist√≥rico ---
        function handleLogout() {
            localStorage.removeItem('currentUser');
            window.location.href = "index.html";
        }
        
        function getHistorico() {
            const user = localStorage.getItem('currentUser');
            return JSON.parse(localStorage.getItem(`historico_${user}`)) || [];
        }

        function salvarPartida(pontos, erros, tempoTotal, nivel, operacao, fator) {
            const historico = getHistorico();
            const data = new Date().toLocaleDateString('pt-BR');
            const hora = new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            
            let configDetalhe = "";
            if (nivel === 'facil') configDetalhe = "Tabuada Aleat√≥ria";
            if (nivel === 'medio') configDetalhe = `Tabuada de ${fator}`;
            if (nivel === 'dificil') configDetalhe = `Express√£o (${operacao})`;

            historico.unshift({ // Adiciona no in√≠cio
                data: `${data} √†s ${hora}`,
                resultado: `${pontos} Acertos / ${erros} Erros`,
                config: `${configDetalhe}`,
                tempo: `${tempoTotal}s`
            });
            
            // Mant√©m apenas as 10 √∫ltimas partidas para n√£o sobrecarregar
            localStorage.setItem(`historico_${localStorage.getItem('currentUser')}`, JSON.stringify(historico.slice(0, 10)));
        }
        
        function showHistorico() {
            const list = document.getElementById('historicoList');
            const historico = getHistorico();
            list.innerHTML = ""; // Limpa a lista

            if (historico.length === 0) {
                list.innerHTML = "<li style='color: gray; list-style: none;'>Nenhuma partida registrada ainda.</li>";
            } else {
                historico.forEach(item => {
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>${item.data}</strong>: ${item.resultado} | N√≠vel: ${item.config} | Dura√ß√£o: ${item.tempo}`;
                    li.style.marginBottom = '8px';
                    li.style.borderBottom = '1px dotted rgba(255, 255, 255, 0.1)';
                    li.style.paddingBottom = '5px';
                    li.style.listStyleType = 'none';
                    list.appendChild(li);
                });
            }

            document.getElementById('config').style.display = 'none';
            document.getElementById('jogo').style.display = 'none';
            document.getElementById('historicoSection').style.display = 'block';
            document.querySelector('.bottom-buttons').style.display = 'block';
            document.getElementById('welcome-message').style.display = 'none';
        }

        function hideHistorico() {
            document.getElementById('historicoSection').style.display = 'none';
            document.getElementById('config').style.display = 'block';
        }

        // --- L√≥gica de Gera√ß√£o de Perguntas ---
        function gerarPerguntas(n) {
            return Math.floor(Math.random() * n) + 1;
        }

        function gerarExpressao() {
            let num1 = gerarPerguntas(10);
            let num2 = gerarPerguntas(10);
            let num3 = gerarPerguntas(5);
            const ops = ['+', '-', '*', '/'];
            const op1 = ops[Math.floor(Math.random() * 4)];
            const op2 = ops[Math.floor(Math.random() * 4)];
            
            // Simplificando a express√£o para garantir que a divis√£o seja exata e a resposta positiva
            if (op1 === '/' || op2 === '/') {
                 // Garante que a primeira opera√ß√£o (a mais complexa) seja simples
                 num1 = gerarPerguntas(9) * gerarPerguntas(9);
                 num2 = Math.floor(Math.random() * 9) + 1;
                 while (num1 % num2 !== 0) {
                     num1 = gerarPerguntas(9) * gerarPerguntas(9);
                     num2 = Math.floor(Math.random() * 9) + 1;
                 }
            }
            
            let expressao = `(${num1} ${op1} ${num2}) ${op2} ${num3}`;
            let resultado;
            
            // Usa 'eval' com cautela, mas √© a forma mais simples para esta demonstra√ß√£o
            try {
                // A express√£o √© avaliada por ordem de preced√™ncia (Multiplica√ß√£o/Divis√£o primeiro)
                // Usando Math.round para evitar d√≠zimas no caso de divis√µes controladas
                resultado = Math.round(eval(expressao.replace('√ó', '*').replace('√∑', '/'))); 
                
                if (resultado < 0 || resultado > 100) return gerarExpressao(); // Tenta novamente se for muito grande ou negativo
                if (op1 === '/' && op2 === '/' && (num1 / num2) % 1 !== 0) return gerarExpressao();

            } catch(e) {
                return gerarExpressao();
            }
            
            // Formata para exibi√ß√£o
            expressao = expressao.replace('*', '√ó').replace('/', '√∑');
            return { pergunta: expressao, resposta: resultado };
        }

        function novaPergunta() {
            let num1, num2;
            let pergunta, respostaCorreta;

            if (nivel === 'facil') {
                num1 = gerarPerguntas(10);
                num2 = gerarPerguntas(10);
                pergunta = `Quanto √© ${num1} √ó ${num2}?`;
                respostaCorreta = num1 * num2;
            } else if (nivel === 'medio') {
                num1 = parseInt(fator);
                num2 = gerarPerguntas(10);
                pergunta = `Quanto √© ${num1} √ó ${num2}?`;
                respostaCorreta = num1 * num2;
            } else { // dificil (Express√µes Mistas)
                const expressao = gerarExpressao();
                pergunta = `Quanto √© ${expressao.pergunta}?`;
                respostaCorreta = expressao.resposta;
            }

            perguntaAtual = pergunta;
            respostaCorretaAtual = respostaCorreta;

            document.getElementById("pergunta").innerText = pergunta;
            document.getElementById("resposta").value = "";
            document.getElementById("resposta").disabled = false;
            document.getElementById("btnResponder").disabled = false;
            document.getElementById("resposta").focus();
        }

        // --- L√≥gica do Jogo ---

        function verificar() {
            const respostaInput = document.getElementById("resposta");
            const resposta = parseInt(respostaInput.value);
            const mensagem = document.getElementById("mensagem");

            if(isNaN(resposta) || respostaInput.value.trim() === "") {
                mensagem.style.color="orange";
                mensagem.innerText="‚ö†Ô∏è Por favor, digite sua resposta!";
                return;
            }
            
            respostaInput.disabled = true;
            document.getElementById("btnResponder").disabled = true;

            if(resposta === respostaCorretaAtual){
                pontos++;
                pontosNaPartida++;
                acertosParaBonus--;

                // B√¥nus de Tempo!
                if (acertosParaBonus <= 0) {
                    tempo += 30;
                    document.getElementById("timer").innerText=`‚è≥ Tempo: ${tempo}s (B√îNUS!)`;
                    acertosParaBonus = 10;
                    mensagem.innerText="‚úÖ Acertou! (+30s de B√îNUS!)";
                    mensagem.style.color="#00bcd4"; // Cor do Ciano
                } else {
                    mensagem.style.color="var(--success-color)";
                    mensagem.innerText="‚úÖ Acertou!";
                }

            } else {
                erros++;
                mensagem.style.color="var(--error-color)";
                mensagem.innerText=`‚ùå Errou! A resposta correta era ${respostaCorretaAtual}`;
            }
            
            document.getElementById("pontos").innerText=pontos;
            document.getElementById("bonusCounter").innerText=acertosParaBonus;
            
            setTimeout(novaPergunta, 1000); 
        }

        function iniciarTimer() {
            intervalo = setInterval(()=>{
                tempo--;
                document.getElementById("timer").innerText=`‚è≥ Tempo: ${tempo}s`;
                if(tempo<=0){ 
                    clearInterval(intervalo); 
                    finalizar(); 
                }
            },1000);
        }

        function iniciarJogo(){
            nivel = document.getElementById("nivelSelecionado").value;
            fator = document.getElementById("fatorSelecionado").value;
            operacao = document.getElementById("operacaoSelecionada").value;
            tempo = parseInt(document.getElementById("tempoSelecionado").value);
            pontosNaPartida = 0; // Reseta o contador para o b√¥nus

            document.getElementById("config").style.display="none";
            document.getElementById("jogo").style.display="block";
            document.getElementById("welcome-message").style.display="none"; 
            document.getElementById("timer").innerText=`‚è≥ Tempo: ${tempo}s`;
            document.querySelector('.bottom-buttons').style.display = 'none'; // Esconde hist√≥rico/sair
            
            // Prepara a interface
            pontos = 0; erros = 0; acertosParaBonus = 10;
            document.getElementById("pontos").innerText = pontos;
            document.getElementById("bonusCounter").innerText = acertosParaBonus;
            document.getElementById("mensagem").innerText = "";
            document.getElementById("graficoFinal").style.display = "none";
            
            novaPergunta();
            iniciarTimer();
        }
        
        function reiniciarPontos() {
             // Mant√©m o n√≠vel, fator e tempo selecionados
             pontos = 0; erros = 0; pontosNaPartida = 0; acertosParaBonus = 10;
             document.getElementById("pontos").innerText = "0";
             document.getElementById("bonusCounter").innerText = "10";
             document.getElementById("graficoFinal").style.display = "none";
             document.getElementById("jogo").style.display = "block";
             document.getElementById("mensagem").innerText = "";
             if (meuGrafico) meuGrafico.destroy();
             iniciarJogo();
        }

        function finalizar(){
            document.getElementById("pergunta").innerText="üèÅ Fim do jogo!";
            document.getElementById("resposta").disabled=true;
            document.getElementById("btnResponder").disabled=true;
            document.getElementById("graficoFinal").style.display="block";
            document.getElementById("mensagem").innerText=`üéâ Resultado: ${pontos} Acertos e ${erros} Erros.`;
            document.getElementById("mensagem").style.color="var(--accent-color)";
            document.querySelector('.bottom-buttons').style.display = 'flex'; // Volta a mostrar
            
            // Salva no hist√≥rico antes de mostrar o gr√°fico
            const tempoInicial = parseInt(document.getElementById("tempoSelecionado").value);
            salvarPartida(pontos, erros, tempoInicial, nivel, operacao, fator);

            const ctx=document.getElementById("meuGrafico").getContext("2d");
            
            if (meuGrafico) meuGrafico.destroy();

            meuGrafico = new Chart(ctx,{
                type:"bar",
                data:{ labels:["Acertos","Erros"], datasets:[{label:"Resultado do Jogo", data:[pontos,erros], backgroundColor:["var(--success-color)","#f44336"], borderRadius: 5}] },
                options:{ responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true,ticks:{stepSize:1, color: 'white'},grid: { color: 'rgba(255, 255, 255, 0.1)' }},x:{ticks:{ color: 'white'},grid: { display: false }}} }
            });
        }
        
        // --- UX Inicial ---
        window.onload = function() {
            const currentUser = localStorage.getItem('currentUser');
            if (!currentUser) {
                window.location.href = "index.html"; 
            } else {
                document.getElementById('welcome-message').innerText = `Bem-vindo(a), ${currentUser}! Configure seu desafio.`;
            }
            // Chama a fun√ß√£o para ocultar/mostrar op√ß√µes ao mudar o n√≠vel
            document.getElementById('nivelSelecionado').addEventListener('change', toggleConfig);
            toggleConfig();
        };

        function toggleConfig() {
            const nivel = document.getElementById('nivelSelecionado').value;
            
            // M√©dio: Mostra a escolha da tabuada (fator)
            document.getElementById('tabuadaEspec').style.display = (nivel === 'medio') ? 'block' : 'none';
            
            // Dif√≠cil: Mostra a escolha da opera√ß√£o (e esconde o fator)
            document.getElementById('operacaoSel').style.display = (nivel === 'dificil') ? 'block' : 'none';
        }

    </script>
</body>
</html>
